<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My CloudDiary - My Images</title>

  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Quicksand:wght@500&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Quicksand',sans-serif;}
    body{background:linear-gradient(180deg,#fff8fa 0%, #ffeef3 100%);min-height:100vh;padding:18px;}
    header{background:#ff9bbd;color:#fff;padding:14px;border-radius:10px;text-align:center;font-family:'Dancing Script',cursive;font-size:1.6rem;box-shadow:0 4px 10px rgba(0,0,0,0.08);}
    .container{max-width:800px;margin:20px auto;}
    .img-list{display:flex;flex-direction:column;gap:12px;margin-top:14px;}
    .item{background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(255,182,193,0.12);padding:10px 14px;cursor:pointer;transition:0.3s;}
    .item:hover{transform:scale(1.01);}
    .title{font-weight:600;color:#4b3b3b;display:flex;justify-content:space-between;align-items:center;}
    .thumb{width:100%;max-height:260px;object-fit:contain;border-radius:10px;margin-top:10px;display:none;}
    .delete-btn{background:none;border:none;cursor:pointer;font-size:18px;}
    .empty{text-align:center;color:#666;margin-top:40px;}
    .back{margin-top:20px;text-align:center;color:#4b3b3b;text-decoration:underline;cursor:pointer;}
    @media(max-width:500px){.thumb{max-height:200px;}}
  </style>
</head>
<body>
  <header>My Images</header>

  <div class="container">
    <div id="imgList" class="img-list"></div>
    <p id="empty" class="empty" style="display:none;">No images yet. Upload some from the Images page.</p>
    <p class="back" onclick="window.location.href='images.html'">‚¨Ö Back to Images</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDHr1TTUnAjGJyjDOqBuqvo2tnAKiNvdCE",
      authDomain: "my-clouddiary.firebaseapp.com",
      projectId: "my-clouddiary",
      storageBucket: "my-clouddiary.firebasestorage.app",
      messagingSenderId: "859635487485",
      appId: "1:859635487485:web:07bd2c20d274037cade494",
      measurementId: "G-2WVB9HTS5R"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const imgList = document.getElementById('imgList');
    const empty = document.getElementById('empty');

    let currentUserEmail = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) { alert('Please log in first.'); window.location.href='index.html'; return; }
      currentUserEmail = user.email;
      await loadImages();
    });

    async function loadImages(){
      imgList.innerHTML = '';
      const q = query(collection(db,'images'), where('user','==', currentUserEmail));
      const snap = await getDocs(q);
      if (snap.empty) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';

      snap.forEach(docSnap => {
        const d = docSnap.data();
        const id = docSnap.id;

        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="title">
            <span>${d.title}</span>
            <button class="delete-btn" title="Delete">üóëÔ∏è</button>
          </div>
          <img src="${d.dataUrl}" alt="${d.title}" class="thumb">
        `;
        imgList.appendChild(div);

        // expand/collapse image
        const img = div.querySelector('.thumb');
        div.querySelector('.title span').addEventListener('click', () => {
          img.style.display = img.style.display === 'none' ? 'block' : 'none';
        });

        // delete
        div.querySelector('.delete-btn').addEventListener('click', async (e) => {
          e.stopPropagation();
          if (confirm("Delete this image?")) {
            await deleteDoc(doc(db, 'images', id));
            div.remove();
          }
        });
      });
    }
  </script>
</body>
</html>
