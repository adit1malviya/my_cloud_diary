<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My CloudDiary - My Doodles</title>

  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Quicksand:wght@500&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Quicksand',sans-serif;}
    body{background:linear-gradient(180deg,#fff8fa 0%, #ffeef3 100%);min-height:100vh;padding:18px;}
    header{background:#ff9bbd;color:#fff;padding:14px;border-radius:10px;text-align:center;font-family:'Dancing Script',cursive;font-size:1.6rem;box-shadow:0 4px 10px rgba(0,0,0,0.08);}
    .container{max-width:900px;margin:20px auto;}
    .accordion{background:#fff;border-radius:12px;padding:14px;margin-bottom:12px;box-shadow:0 6px 18px rgba(255,182,193,0.12);}
    .accordion-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
    .title{font-weight:600;color:#333;}
    .actions button{background:#fff2f8;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;margin-left:6px;}
    .accordion-content{display:none;margin-top:10px;text-align:center;}
    .accordion-content img{width:100%;max-width:400px;border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,0.1);}
    .back{margin-top:20px;text-align:center;color:#4b3b3b;text-decoration:underline;cursor:pointer;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);justify-content:center;align-items:center;}
    .modal-box{background:#fff;padding:18px;border-radius:10px;text-align:center;max-width:420px;width:90%;}
    .modal-box button{margin:8px;padding:8px 14px;border-radius:8px;border:none;cursor:pointer;}
    .ok{background:#ff6b91;color:#fff;}
    .cancel{background:#ddd;color:#333;}
  </style>
</head>

<body>
  <header>My Doodles</header>

  <div class="container" id="doodleList"></div>
  <p class="back" onclick="window.location.href='doodle.html'">‚¨Ö Back to Doodle</p>

  <!-- Delete confirmation modal -->
  <div id="deleteModal" class="modal">
    <div class="modal-box">
      <p>Are you sure you want to delete this doodle?</p>
      <div>
        <button id="confirmDelete" class="ok">Delete</button>
        <button id="cancelDelete" class="cancel">Cancel</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDHr1TTUnAjGJyjDOqBuqvo2tnAKiNvdCE",
      authDomain: "my-clouddiary.firebaseapp.com",
      projectId: "my-clouddiary",
      storageBucket: "my-clouddiary.firebasestorage.app",
      messagingSenderId: "859635487485",
      appId: "1:859635487485:web:07bd2c20d274037cade494",
      measurementId: "G-2WVB9HTS5R"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const list = document.getElementById('doodleList');
    const modal = document.getElementById('deleteModal');
    const confirmBtn = document.getElementById('confirmDelete');
    const cancelBtn = document.getElementById('cancelDelete');
    let currentUserEmail = null;
    let deleteId = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) { alert('Please log in first.'); window.location.href='index.html'; return; }
      currentUserEmail = user.email;
      loadDoodles();
    });

    async function loadDoodles(){
      list.innerHTML = "";
      const q = query(collection(db,"doodles"), where("user","==",currentUserEmail));
      const snap = await getDocs(q);

      if(snap.empty){
        list.innerHTML = "<p style='text-align:center;color:#666;'>No doodles yet. Create some!</p>";
        return;
      }

      snap.forEach(docSnap=>{
        const d = docSnap.data();
        const id = docSnap.id;

        const acc = document.createElement('div');
        acc.className = "accordion";
        acc.innerHTML = `
          <div class="accordion-header">
            <div class="title">${d.title}</div>
            <div class="actions">
              <button class="edit" data-id="${id}">‚úèÔ∏è</button>
              <button class="delete" data-id="${id}">üóëÔ∏è</button>
            </div>
          </div>
          <div class="accordion-content">
            <img src="${d.dataUrl}" alt="${d.title}">
          </div>
        `;
        list.appendChild(acc);

        const header = acc.querySelector('.accordion-header');
        const content = acc.querySelector('.accordion-content');
        header.addEventListener('click', ()=>{
          content.style.display = content.style.display === "block" ? "none" : "block";
        });
      });

      // Delete button logic
      list.querySelectorAll('.delete').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          deleteId = e.currentTarget.dataset.id;
          modal.style.display = 'flex';
        });
      });

      // Edit button logic
      list.querySelectorAll('.edit').forEach(btn=>{
        btn.addEventListener('click', e=>{
          e.stopPropagation();
          const id = e.currentTarget.dataset.id;
          window.location.href = `doodle.html?edit=${id}`;
        });
      });
    }

    confirmBtn.addEventListener('click', async ()=>{
      if(!deleteId) return;
      await deleteDoc(doc(db,"doodles",deleteId));
      modal.style.display='none';
      deleteId=null;
      loadDoodles();
    });

    cancelBtn.addEventListener('click', ()=>{
      modal.style.display='none';
      deleteId=null;
    });
  </script>
</body>
</html>
